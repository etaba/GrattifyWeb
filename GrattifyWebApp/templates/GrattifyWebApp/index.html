<!DOCTYPE html>

<head>
	<title>Grand Theft Audio</title>
	<center><h1>Grand Theft Audio</h1><center>
	<meta charset="utf-8">
  	<meta name="viewport" content="width=device-width, initial-scale=1">
  	<!-- Latest AngularJS -->
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<!-- Latest compiled JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
	<div ng-app="myApp" ng-controller="myCtrl" class="container-fluid">
	<center>

	{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}
	{% csrf_token %}
	<input type="radio" ng-model="entryType" value="track"/>Track
	<input type="radio" ng-model="entryType" value="album"/>Album
	<input type="text"  ng-model="track.artist" placeholder="Artist" ng-keypress="onKeyPress($event)" id="artist_input"/>
	<input type="text"  ng-model="track.title"  placeholder="Track or Album Title" ng-keypress="onKeyPress($event)"/>
	<input type="text"  ng-model="track.ytlink" placeholder="Youtube Link (optional)" ng-keypress="onKeyPress($event)"/>
	<button ng-click="addTrack()" id="add_button">Add</button>
	<br>
	<br>
		<button ng-click="downloadTracks()" class="btn btn-primary">
			<span style="font-size:1.5em;vertical-align:middle" title="Download All" class="glyphicon glyphicon-download-alt"></span>
		</button>
	<br>


	{% verbatim %}
	<table ng-if="tracks.length > 0"class="table table-striped table-hover">
		<thead>
			<tr>
				<th style="width:4%"></th>
				<th style="width:32%">Artist</th>
				<th style="width:32%">Track</th>
				<th style="width:32%">YouTube</th>
			</tr>
		</thead>
		<tr ng-repeat="t in tracks">
			<td>
				<p data-placement="top" data-toggle="tooltip" title="Delete">
					<button ng-click="deleteRow($index)" class="btn btn-danger btn-xs" data-title="Delete">
						<span class="glyphicon glyphicon-trash"></span>
					</button>
				</p>
			</td>
			<td>
				{{ t.artist }}
			</td>
			<td>
				{{ t.title }}
			</td>
			<td>
				{{ t.ytlink }}
			</td>
		</tr>
	</table>
	{% endverbatim %}
	</center>
	</div>
</body>

<script>

	var app = angular.module('myApp',[]);
	app.config(['$httpProvider', function($httpProvider){
		$httpProvider.defaults.xsrfCookieName = 'csrftoken';
		$httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
	}])
	app.controller('myCtrl', function($scope,$http){
		document.getElementById("artist_input").focus();
		$scope.entryType = "track";
		$scope.tracks = [];
		$scope.track = {};

		$scope.addTrack = function(){
			if($scope.track.artist === undefined && $scope.track.title == undefined && $scope.track.ytlink == undefined)
			{
				document.getElementById("artist_input").focus();
				return;
			}
			if($scope.entryType == "album")
			{
				$http({
					url: "getAlbumTracks",
					method: 'POST',
					data: $scope.track
				}).then(function mySuccess(response) {
						for(albumTrack of response.data.tracks){
							$scope.tracks.unshift({artist:$scope.track.artist, title:albumTrack});
						}
				    }, function myError(response) {
				      alert("Could not find that album :(");
				  	});
			}
			else{
				$scope.tracks.unshift({artist:$scope.track.artist, title:$scope.track.title, ytlink:$scope.track.ytlink});
			}
			$scope.track.artist = undefined;
			$scope.track.title = undefined;
			$scope.track.ytlink = undefined;
			document.getElementById("artist_input").focus();
		}

		$scope.clearTracks = function(){
			$scope.tracks = [];
		}

		$scope.deleteRow = function(rowID){
			$scope.tracks.splice(rowID,1);
		}
		$scope.downloadTracks = function(){
			$http({
					url: "downloadTracks",
					method: 'POST',
					data: $scope.tracks,
				}).then(function mySuccess(response) {
						if(response.data.failedTracks.length > 0)
						{
							//do stuff to track table here
							alert("Some tracks failed to download :(");
						}
						else
						{
							$scope.zipPath = response.data.zipPath;
							$http.get('/serveZip',{responseType:'arraybuffer'}).then(function zipReady(response){
								var a = document.createElement('a');
								var blob = new Blob([response.data], {'type':"application/zip"}); //try octet-stream instead of zip if this breaks
								a.href = URL.createObjectURL(blob);
								a.download = $scope.zipPath;
								a.click();
							}, function zipNotReady(response){
								alert('no response!?');
							});
							
							//$http.post("serveZip");
						}
				    });
		}

		$scope.onKeyPress = function($event) {
		      if ($event.keyCode == 13) {
		          // Here is where I must fire the click event of the button
		          $scope.addTrack();
		      }
		  }; 
	})

	
</script>	