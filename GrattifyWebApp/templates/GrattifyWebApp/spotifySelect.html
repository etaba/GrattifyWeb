<!DOCTYPE html>
<!--{% load static %}-->
<head>
	<title>Which Playlists</title>
	<center><h1>Spotify Select</h1><center>
	<meta charset="utf-8">
  	<meta name="viewport" content="width=device-width, initial-scale=1">
  	<!-- Latest AngularJS -->
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<!-- Latest compiled JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<!-- Angular Routes -->
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-route.js"></script>

	<script src="{% static "script.js" %}"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-filter/0.5.14/angular-filter.js"></script>
</head>
<body>
	{%verbatim%}
<div ng-app="myApp" ng-controller="spotifySelectionCtrl" ng-init="init()">
	<div ng-if="selectedPlaylists.length == 0">
		<div class="funkyradio">
	        <div ng-repeat="p in playlists" class="funkyradio-default">
	            <input type="checkbox" id="{{ p.id }}" class="plCheckbox" checked/>
	            <label for="{{ p.id }}">{{ p.name }}</label>
	        </div>
    	</div>
		<button ng-click="addPlaylistsToQueue()">Done</button>
	</div>
	<div ng-if="selectedPlaylists.length > 0">
		<br>
			<button   ng-click="downloadPlaylists(selectedPlaylists)" class="btn btn-primary">
				<span style="font-size:1.5em;vertical-align:middle" title="Download All" class="glyphicon glyphicon-download-alt"></span>
			</button>
		<br>

		<table class="table table-striped table-hover">
			<thead>
				<tr>
					<th style="width:4%"></th>
					<th style="width:32%">Artist</th>
					<th style="width:32%">Track</th>
					<th style="width:32%">YouTube</th>
				</tr>
			</thead>
			<tbody ng-repeat="p in selectedPlaylists">
				<tr>
					<th>
						<p data-placement="top" data-toggle="tooltip" title="Delete">
							<button ng-click="deletePlaylist(p.id)" class="btn btn-danger btn-xs" data-title="Delete All In Playlist">
								<span style="font-size:2em;" class="glyphicon glyphicon-trash"></span>
							</button>
						</p>
					</th>
					<th >{{ p.name }}</th>
				</tr>
				<tr ng-repeat="t in p.tracks">
					<td>
						<p data-placement="top" data-toggle="tooltip" title="Delete">
							<button ng-click="deletePlaylistRow(p.id,$index)" class="btn btn-danger btn-xs" data-title="Delete">
								<span class="glyphicon glyphicon-trash"></span>
							</button>
						</p>
					</td>
					<td>
						{{ t.artist }}
					</td>
					<td>
						{{ t.title }}
					</td>
					<td>
						<a target="_blank" href="{{ t.ytlink }}">{{ t.ytlink }}</a>
					</td>
				</tr>
			</tbody>
		</table>
		<button ng-click="downloadTracks(selectedPlaylists[0],'ClassicRockPlaylist')">ClassicRock</button>
		<button ng-click="downloadTracks(selectedPlaylists[1],'RapPlaylist')">Rap</button>
	</div>
</div>
{%endverbatim%}
	{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}
	{% csrf_token %}
	
	</center>
	</div>
</body>
<script>
    var app = angular.module('myApp', ["ngRoute", 'angular.filter']);
    app.config(['$httpProvider', function($httpProvider) {
        $httpProvider.defaults.xsrfCookieName = 'csrftoken';
        $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
    }]);

    app.directive( 'elemReady', function( $parse ) {
   return {
       restrict: 'A',
       link: function( $scope, elem, attrs ) {    
          elem.ready(function(){
            $scope.$apply(function(){
                var func = $parse(attrs.elemReady);
                func($scope);
            })
          })
       }
    }
});

    app.controller('spotifySelectionCtrl', function($scope, $http, $timeout, $q) {
        $scope.parseHash = function(urlHash) {
            var hashContents = {};
            var fieldStart, valueStart, currField;
            for (i = 0; i < urlHash.length; i++) {
                if (i == urlHash.length - 1) {
                    //get last field value
                    hashContents[currField] = urlHash.substr(valueStart);
                }
                switch (urlHash[i]) {
                    case ('#'):
                        //first field
                        fieldStart = i + 1;
                        break;
                    case ('&'):
                        hashContents[currField] = urlHash.substr(valueStart, i - valueStart);
                        fieldStart = i + 1;
                        break;
                    case ('='):
                        currField = urlHash.substr(fieldStart, i - fieldStart);
                        valueStart = i + 1;
                        break;
                }
            }
            return hashContents;
        };

        $scope.init = function() {
            //grant = {'access_token','state','token_type','expires_in'}
            $scope.spotifyGrant = $scope.parseHash(String(window.location.hash));
            $scope.playlists = [];
        	$scope.selectedPlaylists = []
            var userID
            var oauthHeader = {
                'Authorization': 'Bearer ' + $scope.spotifyGrant['access_token']
            };
            //oh god time to get the playlist data
            $http({
                method: 'GET',
                url: 'https://api.spotify.com/v1/me',
                headers: oauthHeader
            }).then(function success(response) {
                    userID = response.data['id'];
                    $http({
                        method: 'GET',
                        url: 'https://api.spotify.com/v1/users/' + userID + '/playlists',
                        headers: oauthHeader
                    }).then(function success(response) {
                            response.data['items'].forEach(function(playlist) {
                                $http({
                                    method: 'GET',
                                    url: playlist['tracks']['href'],
                                    headers: oauthHeader,
                                }).then(function success(response) {
                                        var tracks = [];
                                        response.data['items'].forEach(function(track) {
                                            tracks.push({
                                                'title': track['track']['name'],
                                                'artist': track['track']['artists'][0]['name']
                                            });
                                        });
                                        $scope.playlists.push({
                                            'name': playlist['name'],
                                            'id': playlist['id'],
                                            'tracks': tracks
                                        });
                                    },
                                    function error(response) {
                                        alert('Error getting tracks for playlist ' + playlist['name']);
                                    });
                            });
                        },
                        function error(response) {
                            alert('Error getting user playlists!');
                        });
                },
                function error(response) {
                    alert('Error getting user profile!');
                });
			

        };

        $scope.addPlaylistsToQueue = function(){
        	$scope.playlists.forEach(function(playlist){
        		if ($('#'+playlist['id'])[0].checked){
        			$scope.selectedPlaylists.push(playlist);
        			playlist.tracks.forEach(function(track){
        				if(track.ytlink == undefined) //link not provided
						{
							$http({
								url: "../getYtlink",
								method: 'POST',
								data: track
							}).then(function success(response) {
								//$scope.tracks[0].ytlink = response.data.link;
								track.ytlink = response.data.link;
							}, function error(response){
								alert("Could not find a youtube link for that song, please provide one manually :(");
							});
						}
        			})
        		}
        	})
        	console.log($scope.selectedPlaylists);
        }

        $scope.downloadPlaylists = function(playlists){
        	$scope.downloadTracks(playlists[0].tracks,playlists[0].name).then(function success(){$scope.downloadTracks(playlists[1].tracks,playlists[1].name)});
        	//		i++
        	//	});
        	//var i = 0;
        	//while (i < playlists.length - 1){
        	//	var playlist = playlists[i];
        	//	$scope.downloadTracks(playlist.tracks,playlist.name).then(function success(){
        	//		i++
        	//	});
        	//	console.log('sent download request for' + playlist.name)
        	//}
        	//playlists.forEach(function(playlist){
        	//	$scope.downloadTracks(playlist.tracks,playlist.name).then(
        	//		);
        	//})
        }
        $scope.downloadTracks = function(tracks,folderName){
        	//var deferred = $q.defer();
			return $http({
					url: "../downloadTracks",
					method: 'POST',
					data: tracks,
				}).then(function success(response) {
						if(response.data.failedTracks.length > 0)
						{
							//do stuff to track table here
							alert("Some tracks failed to download :(");
						}
						else
						{
							$http({
								url: "../serveZip",
								method: 'GET',
								params: {'name':folderName},
								responseType: 'arraybuffer'
							}).then(function success(response){
									var a = document.createElement('a');
									var blob = new Blob([response.data], {'type':"application/zip"}); //try octet-stream instead of zip if this breaks
									a.href = URL.createObjectURL(blob);
									a.download = folderName+'.zip';
									a.click();
									//deferred.resolve();
									//return deferred.promise;
							}, function error(response){
								alert('Failed to download zip from server');
								//deferred.reject(response);
								//return deferred.promise;
							});
						}
				    },function error(response) {
				    	alert("Error downloading " + folderName + " tracks");
				    	//deferred.reject(response);
				    	//return deferred.promise;
				    });
		}

		$scope.deletePlaylist = function(playlistID){
			$scope.selectedPlaylists = $scope.selectedPlaylists.filter(function(playlist){
				return playlist['id'] != playlistID;
				console.log(playlist['id'])
				console.log(playlist['id'] != playlistID)
			});
		}

		$scope.deletePlaylistRow = function(playlistID,rowIndex){
			$scope.selectedPlaylists.forEach(function(playlist){
				if (playlist.id == playlistID){
					playlist.tracks.splice(rowIndex,1);
				}
			});
		}

		$scope.tryZip = function(){
			$http({
				url: "../serveZip",
				method: 'GET',
				params: {'name':'YourMusic_76viehmlms1bg4r74d32xbs76v3d4k46'},
				responseType:"arraybuffer"
			}).then(function zipReady(response){
					var a = document.createElement('a');
					var blob = new Blob(/*[new Uint8Array(response.data)]*/[response.data], {'type':"application/zip"}); //try octet-stream instead of zip if this breaks
					a.href = URL.createObjectURL(blob);
					a.download = 'YourMusic_76viehmlms1bg4r74d32xbs76v3d4k46.zip';
					a.click();
			}, function error(response){
				alert('no response!?');
			});
		}
    });

	
</script>